## HTTPS原理

HTTPS 还是通过了 HTTP 来传输信息，但是信息通过 SSL/TLS 协议进行了加密。

HTTP 是使用明文通讯的，第三方可以获知或者修改通讯内容，冒充他人身份。SSL/TLS 协议对传播信息进行了加密，第三方无法窃听，而且具有校验机制，一旦被篡改，通讯双方会立刻发现，还配备身份证书，防止冒充。

### SSL/TLS

互联网加密通信协议的历史：

> 1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布。

> 1995年，NetScape公司发布SSL 2.0版，很快发现有严重漏洞。

> 1996年，SSL 3.0版问世，得到大规模应用。

> 1999年，互联网标准化组织ISOC接替NetScape公司，发布了SSL的升级版TLS 1.0版。

> 2006年、2008年，2018年，TLS进行了三次升级，分别为TLS 1.1、TLS 1.2、TLS 1.3。

SSL(Secure Sockets Layer 安全套接层)，位于TCP/IP协议与各种应用层之间。可以分为两层，SSL记录协议与SSL握手协议。

TLS(Transport Layer Security 传输层安全性协议)，包含记录层和传输层。记录层协议确定传输层数据的封装格式。传输层安全协议使用X.509认证，之后利用非对称加密演算来对通信方做身份认证，之后交换对称密钥作为会谈密钥（Session key）。

### 原理

SSL/TLS协议的基本思路是采用公钥加密法，将公钥放在数字证书中，保证不被篡改。非对称加密解密消耗的时间较多，所以在SSL/TLS每一次对话（session），客户端和服务器端都生成一个"对话密钥"（session key），用它来加密信息。由于"对话密钥"是对称加密，所以运算速度非常快，而服务器公钥只用于加密"对话密钥"本身，这样就减少了加密运算的消耗时间。

在 SSL/TLS 中使用了两种加密技术，分别为：对称加密和非对称加密。

#### 对称加密：

对称加密就是两边拥有相同的秘钥，两边都知道如何将密文加密解密。

#### 非对称加密：

有公钥私钥之分，公钥所有人都可以知道，可以将数据用公钥加密，但是将数据解密必须使用私钥解密，私钥只有分发公钥的一方才知道。客户端先向服务器端索要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

#### 握手过程

![](https://gitarticle.oss-cn-shanghai.aliyuncs.com/javascript/images/tls-shake.png)

1.**ClientHello**：客户端发送一个随机值(稍后用于生成对话密钥)，支持的协议版本和支持的加密方法，支持的压缩方法。这里需要注意的是，客户端发送的信息之中不包括服务器的域名。也就是说，理论上服务器只能包含一个网站，否则会分不清应该向客户端提供哪一个网站的数字证书。这就是为什么通常一台服务器只能有一张数字证书的原因。

对于虚拟主机的用户来说，这当然很不方便。2006年，TLS协议加入了一个Server Name Indication扩展，允许客户端向服务器提供它所请求的域名。

2.**SeverHello**：服务端收到客户端的随机值，自己也产生一个随机值，并根据客户端需求的协议和加密方式来使用对应的方式，发送自己的证书（如果需要验证客户端证书就会再包含一项请求，要求客户端提供"客户端证书"。）

3.客户端回应：客户端收到服务端的证书并验证是否有效，验证通过就会从证书中取出服务器的公钥，然后，向服务器发送下面三项信息。

- 一个随机数。该随机数用服务器公钥加密，防止被窃听。
- 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
- 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

上面第一项的随机数，是整个握手阶段出现的第三个随机数，又称"pre-master key"。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把"会话密钥"。

4.服务器最后回应：服务器收到客户端的第三个随机数pre-master key之后，计算生成本次会话所用的"会话密钥"。然后，向客户端最后发送下面信息。

- 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
- 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用"会话密钥"加密内容。

通过以上步骤可知，在 TLS 握手阶段，两端使用非对称加密的方式来通信，但是因为非对称加密损耗的性能比对称加密大，所以在正式传输数据时，两端使用对称加密的方式通信。

生成对话密钥一共需要三个随机数。

握手之后的对话使用"对话密钥"加密（对称加密），服务器的公钥和私钥只用于加密和解密"对话密钥"（非对称加密），无其他作用。

服务器公钥放在服务器的数字证书之中。

整个对话过程中（握手阶段和其后的对话），服务器的公钥和私钥只需要用到一次。这就是CloudFlare能够提供Keyless服务的根本原因。

某些客户（比如银行）想要使用外部CDN，加快自家网站的访问速度，但是出于安全考虑，不能把私钥交给CDN服务商。这时，完全可以把私钥留在自家服务器，只用来解密对话密钥，其他步骤都让CDN服务商去完成。

整个握手阶段都不加密（也没法加密），都是明文的。因此，如果有人窃听通信，他可以知道双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数（Premaster secret）能不能被破解。

PS：以上说明的都是 TLS 1.2 协议的握手情况，在 1.3 协议中，首次建立连接只需要一个 RTT，后面恢复连接不需要 RTT 了。

### 参考链接
- [SSL/TLS协议运行机制的概述](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)
- [图解SSL/TLS协议](http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html)
